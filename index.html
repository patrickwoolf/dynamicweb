<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dynamic Website Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
      text-align: center;
    }

    h1 {
      color: #333;
    }

    .form-group {
      position: relative;
      width: 80%;
      margin-bottom: 20px;
      background-color: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      display: inline-block;
    }

    .form-group textarea {
      width: calc(100% - 30px);
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: none;
      overflow-y: hidden;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
    }

    textarea {
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      background-color: #4caf50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    .selectable-box {
      display: inline-block;
      padding: 8px;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .selectable-box:hover {
      background-color: #e0f7fa;
    }

    .selectable-box.selected {
      background-color: #c8e6c9;
    }

    .delete-button {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 15px;
      background-color: transparent;
      color: black;
      border: none;
      padding: 1px;
      border-radius: 50%;
      cursor: pointer;
    }

    #resultContainer {
      margin-top: 20px;
      text-align: left;
      font-family: Consolas, monospace;
      font-size: 12px;
    }

    p {
      background-color: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .inline-textarea {
      display: inline-block;
      font-family: inherit;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px;
      width: 90px;
      height: 24px;
      resize: none;
      vertical-align: middle;
      overflow: hidden;
    }

    /* Floating image box */
    #floatingBox {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      display: flex;
      align-items: center;
      background-color: #ffffffcc;
      padding: 5px 10px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    #floatingBox img {
      width: 24px;
      height: auto;
    }

    #floatingBox span {
      margin-left: 8px;
      font-size: 12px;
      color: #333;
    }
  </style>
</head>

<body>
  <h1>Dynamic Website Generator</h1>

  <!-- Floating icon + arrow text -->
  <div id="floatingBox">
    <a href="https://github.com/patrickwoolf/dynamicweb" target="_blank">
      <span>copy templates here →</span>
      <img src="icon.png" alt="Homepage">
    </a>
  </div>

  <i>Patrick Yi-Hong Wu</i>
  <p>PE: {intact, impaired} <br>↓<br>
    PE:
    <span class="selectable-box" onclick="toggleSelected(this)">intact</span>
    <span class="selectable-box" onclick="toggleSelected(this)">impaired</span>
  </p>

  <form id="dynamicForm">
    <div id="dynamicContent"></div>
    <button type="button" onclick="addFormGroup()">Add Form</button>
    <button type="button" onclick="generateResult()">Generate Result</button>
  </form>

  <div id="fontControls" style="text-align: center; margin-bottom: 10px;">
    <button type="button" id="decreaseFontBtn">−</button>
    <button type="button" id="increaseFontBtn">+</button>
  </div>

  <div id="resultContainer"></div>
  <button type="button" onclick="copyResult()">Copy Result</button>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      addFormGroup();
      loadSavedValues();
      loadDefaultContent();
    });

    async function loadDefaultContent() {
      const dynamicContent = document.getElementById('dynamicContent');
      const hasSavedData = Object.keys(localStorage).some(key => key.startsWith('textarea'));

      if (hasSavedData) return;

      try {
        const res = await fetch('CVA-consult.txt');
        if (!res.ok) throw new Error(res.statusText);
        const txt = await res.text();

        let fg = dynamicContent.firstElementChild;
        if (!fg) { addFormGroup(); fg = dynamicContent.firstElementChild; }

        const ta = fg.querySelector('textarea');
        ta.value = txt;
        autoResize(ta);
        saveValueToLocalStorage(ta);
      } catch (e) { console.error(e); }
    }

    function addFormGroup() {
      const dc = document.getElementById('dynamicContent');
      const fg = document.createElement('div');
      fg.classList.add('form-group');

      const lbl = document.createElement('label');
      lbl.textContent = 'Enter your content:';

      const ta = document.createElement('textarea');
      ta.placeholder = 'Type here...';
      ta.id = 'textarea' + dc.childElementCount;
      ta.addEventListener('input', () => { autoResize(ta); saveValueToLocalStorage(ta); });

      const del = document.createElement('button');
      del.textContent = 'x';
      del.classList.add('delete-button');
      del.onclick = () => { dc.removeChild(fg); localStorage.removeItem(ta.id); };

      fg.append(lbl, ta, del);
      dc.appendChild(fg);
    }

    function autoResize(ta) {
      ta.style.height = 'auto';
      ta.style.height = ta.scrollHeight + 'px';
      if (ta.classList.contains('inline-textarea')) {
        ta.style.width = (ta.scrollWidth + 5) + 'px';
      }
    }

    function saveValueToLocalStorage(ta) {
      localStorage.setItem(ta.id, ta.value);
    }

    function loadSavedValues() {
      const dcs = document.getElementById('dynamicContent').getElementsByClassName('form-group');
      for (const fg of dcs) {
        const ta = fg.querySelector('textarea');
        const v = localStorage.getItem(ta.id);
        if (v !== null) { ta.value = v; autoResize(ta); }
      }
    }

    function toggleSelected(el) {
      el.classList.toggle('selected');
    }

    function generateResult() {
      const rc = document.getElementById('resultContainer');
      rc.innerHTML = '';
      const groups = document.getElementById('dynamicContent').getElementsByClassName('form-group');

      for (const fg of groups) {
        const ta = fg.querySelector('textarea');
        const frag = document.createDocumentFragment();
        const lines = ta.value.split('\n');

        for (let i = 0; i < lines.length; i++) {
          if (i > 0) frag.appendChild(document.createElement('br'));
          const line = lines[i];
          const regex = /\{([^}]*)\}/g;
          let match, last = 0;

          while ((match = regex.exec(line))) {
            appendFragment(frag, line.slice(last, match.index));
            const opts = match[1].trim().split(',').map(s => s.trim());
            opts.forEach(o => {
              const b = document.createElement('div');
              b.textContent = o;
              b.classList.add('selectable-box');
              b.onclick = () => b.classList.toggle('selected');
              frag.appendChild(b);
            });
            last = regex.lastIndex;
          }
          appendFragment(frag, line.slice(last));
        }

        const p = document.createElement('p');
        p.appendChild(frag);
        rc.appendChild(p);
      }
    }

    function appendFragment(f, text) {
      const parts = text.split('___');
      parts.forEach((pt, i) => {
        if (pt) f.appendChild(document.createTextNode(pt));
        if (i < parts.length - 1) {
          const it = document.createElement('textarea');
          it.placeholder = 'Type here...';
          it.classList.add('inline-textarea');
          it.addEventListener('input', () => autoResize(it));
          f.appendChild(it);
        }
      });
    }

    function copyResult() {
      const ps = document.getElementById('resultContainer').getElementsByTagName('p');
      let out = '';

      for (const p of ps) {
        let node = p.firstChild, line = '';
        while (node) {
          if (node.nodeType === Node.TEXT_NODE) line += node.nodeValue;
          else if (node.tagName === 'DIV' && node.classList.contains('selected')) line += node.textContent;
          else if (node.tagName === 'TEXTAREA') line += node.value;
          else if (node.tagName === 'BR') line += '\n';
          node = node.nextSibling;
        }
        out += line.trim() + '\n';
      }

      if (out.trim()) {
        navigator.clipboard.writeText(out).then(() => alert('Copied:\n' + out));
      } else alert('No result to copy!');
    }

    // Font controls
    const rc = document.getElementById('resultContainer');
    const inc = document.getElementById('increaseFontBtn');
    const dec = document.getElementById('decreaseFontBtn');
    let fz = 10;
    const update = s => { fz = Math.min(30, Math.max(6, s)); rc.style.fontSize = fz + 'px'; };
    inc.addEventListener('click', () => update(fz + 1));
    dec.addEventListener('click', () => update(fz - 1));
    update(fz);
  </script>
</body>

</html>
